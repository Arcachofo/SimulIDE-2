#chip tiny13a, 4.8

#define PWM_Out1 PortB.0
#define ADSpeed MediumSpeed
#define USE_AD1 TRUE
#define USE_AD0 FALSE
#define USE_AD2 FALSE
#define USE_AD3 FALSE

DIR PWM_Out1 OUT
DIR PortB.2 IN
                          '8s WDT x MAX_NUM = time before the main program is really executed
#DEFINE MAX_NUM 1         'set to 225 to do something every 30 min, debug set to 1 (8s WDT)
watchdog_off              'deactivate the watchdog, good practice

'Set Variables
DIM TIMEOUT, LDR AS BYTE
Dim myflag as byte
dim tblCounter1, tablecounter2 as byte
DIM Invalue1, invalue2 AS WORD

TIMEOUT = MAX_NUM       'set timer intervall - while the mcu mostly sleeps
ON INTERRUPT WDT CALL wdt_wakeup

do
    wdt_sleep
    TIMEOUT -= 1
    IF TIMEOUT = 0 THEN
      LDR = READAD(ADC1)
      IF LDR <= 60 THEN
        PORTB.0 = 1
      ELSE
        PORTB.0 = 0
      END IF
    
      TIMEOUT = MAX_NUM
    END IF
loop

SUB watchdog_off
    INToff
    wdr
    MCUSR = 0b00000000
    WDTCR = 0b00011000      'timed sequence to switch the WDT off
    WDTCR = 0b00000000
    INTon
END SUB

SUB watchdog_on
    INToff
    wdr
    'WDT-Prescaler value = 8 s, WDT set to Interrupt (WDTIE) not reset
    WDTCR=0b00011000
    WDTCR=0b01101001
    INTon
END SUB

SUB wdt_sleep
    PRR = 0b0000011 'Timer0 and ADC off
    DIDR0 = 0b00111111 'digital inputs off
    watchdog_on
    myflag = 1
    Wait While myflag = 1
    'MCUCR=0b00110000 'sleep enable and mode poweroff
    'sleep
END SUB

SUB wdt_wakeup
    MCUCR = 0b00000000 'sleep-enable off
    PRR = 0b00000000 'Timer0 and ADC on
    watchdog_off
    myflag = 0
END SUB
